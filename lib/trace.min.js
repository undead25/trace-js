!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e._Trace=t()}(this,function(){"use strict";function e(e){var t=new XMLHttpRequest;if("withCredentials"in t||void 0!==window.XDomainRequest){var n=e.url;"withCredentials"in t?t.onreadystatechange=function(){if(4===t.readyState)if(200===t.status)e.onSuccess=e.onSuccess();else if(e.onError){var n=new Error("Error: "+t.status);n.request=t,e.onError(n)}}:(t=new window.XDomainRequest,n=n.replace(/^https?:/,""),e.onSuccess&&(t.onload=e.onSuccess),e.onError&&(t.onerror=function(){var n=new Error("Error: XDomainRequest");n.request=t,e.onError(n)})),t.open("POST",n,!0),t.send(JSON.stringify(e.data))}}function t(e){switch(Object.prototype.toString.call(e)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return e instanceof Error}}function n(){var e=window.crypto||window.msCrypto;if(e&&e.getRandomValues){var t=new Uint16Array(8);e.getRandomValues(t),t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;var n=function(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t};return n(t[0])+n(t[1])+n(t[2])+n(t[3])+n(t[4])+n(t[5])+n(t[6])+n(t[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(document){var n=void 0,r=void 0;e=e.substr(0,1).toUpperCase+e.substr(1),document.createEvent?(n=document.createEvent("HTMLEvents"),n.initEvent(e,!0,!0)):(n=document.createEventObject(),n.eventType=e);for(r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);document.createEvent?document.dispatchEvent(n):document.fireEvent("on"+n.eventType.toLowerCase(),n)}}function o(e,t,n,r){var o=e[t];e[t]=n(o),r&&r.push([e,t,o])}function i(e,t,n){function r(){var r=[],o=arguments.length,a=!e||e&&!1!==e.deep;for(n&&"function"==typeof n&&n.apply(this,arguments);o--;)r[o]=a?i(e,arguments[o]):arguments[o];try{return t.apply(this,r)}catch(e){throw e}}if(!t&&"function"!=typeof e)return e;if("function"==typeof e&&(t=e,e=void 0),"function"!=typeof t)return t;try{if(t.trace)return t;if(t.track_wrapper)return t.track_wrapper}catch(e){return t}for(var o in t)t.hasOwnProperty(process)&&(r[o]=t[o]);return r.prototype=t.prototype,t.track_wrapper=r,r}function a(e){for(var t=[],n=void 0,r=0;r<e.length;r++)n=e[r],"string"==typeof n?t.push(n.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")):n&&n.source&&t.push(n.source);return new RegExp(t.join("|"),"i")}function c(e){for(var t,n=[],r=0,o=0,i=" > ".length;e&&r++<5&&!("html"===(t=u(e))||r>1&&o+n.length*i+t.length>=80);)n.push(t),o+=t.length,e=e.parentElement;return n.reverse().join(" > ")}function u(e){var t,n,r,o,i,a=[];if(!e||!e.tagName)return"";if(a.push(e.tagName.toLowerCase()),e.id&&a.push("#"+e.id),(t=e.className)&&"string"==typeof t)for(n=t.split(/\s+/),i=0;i<n.length;i++)a.push("."+n[i]);var c=["type","name","title","alt"];for(i=0;i<c.length;i++)r=c[i],(o=e.getAttribute(r))&&a.push("["+r+'="'+o+'"]');return a.join("")}function s(e){var t=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(t){var n=t[6]||"",r=t[8]||"";return{protocol:t[2],host:t[4],path:t[5],relative:t[5]+n+r}}}function l(e){for(var t={},n=e.attributes,r=0;r<n.length;r++){var o=n[r];t[o.name]=o.value}return t}function f(){return"undefined"==typeof document||void 0===document.location?"":document.location.href}var p={apiKey:"",exceptionUrl:"http://localhost:3001/tracer/error",performanceUrl:"http://localhost:3001/api/perf/create",ignoreErrors:[],ignoreUrls:[],autoBreadcrumbs:{dom:!0,xhr:!0,location:!0,console:!1},releaseStage:"production",catchAjax:!0,catchConsole:!0,maxStackDepth:10,repeatReport:!1,maxBreadcrumbs:100},h={screenWidth:document.documentElement?document.documentElement.clientWidth:document.body.clientWidth,screenHeigth:document.documentElement?document.documentElement.clientHeight:document.body.clientHeight,userAgent:navigator.userAgent,language:navigator.language},d=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},g=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),m=function(){function t(e){d(this,t),this.config=e,this.getCollection()}return g(t,[{key:"payloadSending",value:function(){var t=this;if(this.collection&&!(this.collection.dom<0)){var n=JSON.stringify(this.collection);if(window.navigator&&window.navigator.sendBeacon)console.log("url change"),window.navigator.sendBeacon(this.config.performanceUrl,n);else{var o={url:this.config.performanceUrl,data:n,onSuccess:function(){return r("success",{data:n,src:t.config.performanceUrl}),new Promise(function(){})},OnError:function(e){return r("failure",{data:n,src:t.config.performanceUrl}),e=e||new Error("发送上报请求失败"),new Promise(function(t){return t(e)})}};console.log("url change"),e(o)}}}},{key:"getCollection",value:function(){if(window.performance){var e=window.performance.timing,t=window.performance.navigation,n=window.performance.getEntriesByType("resource"),r=e.redirectEnd-e.redirectStart,o=e.domainLookupEnd-e.domainLookupStart,i=e.connectEnd-e.connectStart,a=0===e.secureConnectionStart?0:e.secureConnectionStart-e.connectStart,c=e.responseStart-e.navigationStart,u=e.responseEnd-e.navigationStart,s=e.domComplete-e.responseEnd,l=e.domContentLoadedEventEnd-e.navigationStart,f=e.domInteractive-e.navigationStart,p=e.loadEventStart-e.navigationStart,h=t.redirectCount,d=t.type,g=[];n.forEach(function(e){var t=e.initiatorType,n=e.name,r=e.duration,o=e.transferSize;g.push({url:n,tag:t,duration:r.toFixed(2),size:o})}),this.collection={redirect:r,dns:o,tcp:i,tls:a,firstPaint:c,network:u,dom:s,firstScreen:l,interactive:f,pageLoad:p,redirectCount:h,navigationType:d,resources:g,userAgent:window.navigator.userAgent,url:window.location.href,protocol:window.location.protocol,apiKey:this.config.apiKey,domain:window.location.protocol+"//"+window.location.host,timing:JSON.stringify(e)}}}}]),t}(),v=Object.assign||require("object-assign"),y=function(){function e(t){d(this,e),this.crumbsData=[],this.wrappedBuiltIns=[],this.lastEvent=null,this.lastHref="",this._config=t,this.getDomBreadcrumbs(),this.getXhrBreadcrumbs(),this.getLocationBreadcurmbs(),this.getConsoleBreadcrumbs()}return g(e,[{key:"getDomBreadcrumbs",value:function(){var e=this;this._config.autoBreadcrumbs.dom&&(this.clickEventSelectors=["a","button","input[button]","input[submit]","input[radio]","input[checkbox]"],this.changeEventSelectors=["input[text]","input[password]","textarea","select"],document.addEventListener?(document.addEventListener("click",function(t){e.eventHandler("click",e.clickEventSelectors,t)},!0),document.addEventListener("blur",function(t){e.eventHandler("input",e.changeEventSelectors,t)},!0)):(document.attachEvent("onclick",function(t){e.eventHandler("click",e.clickEventSelectors,t)}),document.attachEvent("onblur",function(t){e.eventHandler("click",e.clickEventSelectors,t)})))}},{key:"eventHandler",value:function(e,t,n){var r=n.target||n.srcElement;r.tagName.toLowerCase();if(this.acceptTag(r,t)){var o=(l(r),{category:"ui."+e,htmlTree:c(r)});this.captureBreadcrumb(o)}}},{key:"acceptTag",value:function(e,t){var n=e.tagName.toLowerCase();return"input"===n&&e.getAttribute("type")&&(n+="["+e.getAttribute("type")+"]"),t.indexOf(n)>-1}},{key:"getXhrBreadcrumbs",value:function(){function e(e,t){e in t&&"function"==typeof t[e]&&o(t,e,function(e){return i(e)})}if(this._config.autoBreadcrumbs.xhr){var t=this,n=(this._config.autoBreadcrumbs,this.wrappedBuiltIns),r=XMLHttpRequest.prototype;o(r,"open",function(e){return function(t,n){return this._trace_xhr={method:t,url:n,statusCode:null},e.apply(this,arguments)}},n),o(r,"send",function(n){return function(r){function a(){!c._trace_xhr||1!==c.readyState&&4!==c.readyState||(c._trace_xhr.statusCode=c.status,t.captureBreadcrumb({type:"http",category:"xhr",data:c._trace_xhr}))}for(var c=this,u=["onload","onerror","onprogress"],s=0;s<u.length;s++)e(u[s],c);return"onreadystatechange"in c&&"function"==typeof c.onreadystatechange?o(c,"onreadystatechange",function(e){return i(e,void 0,a)}):c.onreadystatechange=a,n.apply(this,arguments)}},n)}}},{key:"getLocationBreadcurmbs",value:function(){if(this._config.autoBreadcrumbs.location){var e=this.wrappedBuiltIns,t=this,n=window.chrome;if(!(n&&n.app&&n.app.runtime)&&window.history&&history.pushState){var r=window.onpopstate;window.onpopstate=function(){var e=location.href;if(t.captureUrlChange(t.lastHref,e),r)return r.apply(this,arguments)},o(history,"pushState",function(e){return function(){var n=arguments.length>2?arguments[2]:void 0;return n&&t.captureUrlChange(t.lastHref,n+""),e.apply(this,arguments)}},e)}}}},{key:"captureUrlChange",value:function(e,t){var n=s(location.href),r=s(t),o=s(e);this.lastHref=t,n.protocol===r.protocol&&n.host===r.host&&(t=r.relative),n.protocol===o.protocol&&n.host===o.host&&(e=o.relative),new m(this._config).payloadSending(),this.captureBreadcrumb({category:"navigation",data:{to:t,from:e}})}},{key:"getConsoleBreadcrumbs",value:function(){var e=this;if(this._config.autoBreadcrumbs.console&&"console"in window&&console.log){var t=function(t,n){e.captureBreadcrumb({message:t,level:n.level,category:"console"})};["debug","info","warn","error","log"].forEach(function(n){e.wrapConsole(console,n,t)})}}},{key:"wrapConsole",value:function(e,t,n){var r=e[t],o=e;if(t in e){var i="warn"===t?"warning":t;e[t]=function(){var e=[].slice.call(arguments),t=""+e.join(" "),a={level:i,logger:"console",extra:{arguments:e}};n&&n(t,a),r&&Function.prototype.apply.call(r,o,e)}}}},{key:"captureBreadcrumb",value:function(e){var t=v({},e,{timestamp:(new Date).getTime()});this.crumbsData.push(t),this.crumbsData.length>this._config.maxBreadcrumbs&&this.crumbsData.shift()}}]),e}(),b={collectWindowErrors:!0,debug:!1},w="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},x=[].slice,k="?",E=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/;b.report=function(){function e(e){i(),p.push(e)}function t(e){for(var t=p.length-1;t>=0;--t)p[t]===e&&p.splice(t,1)}function n(){a(),p=[]}function r(e,t){var n=null;if(!t||b.collectWindowErrors){for(var r in p)if(p.hasOwnProperty(r))try{p[r].apply(null,[e].concat(x.call(arguments,2)))}catch(e){n=e}if(n)throw n}}function o(e,t,n,o,i){var a=null;if(g)b.computeStackTrace.augmentStackTraceWithInitialElement(g,t,n,e),c();else if(i)a=b.computeStackTrace(i),r(a,!0);else{var u,l={url:t,line:n,column:o},p=void 0,h=e;if("[object String]"==={}.toString.call(e)){var u=e.match(E);u&&(p=u[1],h=u[2])}l.func=k,a={name:p,message:h,url:f(),stack:[l]},r(a,!0)}return!!s&&s.apply(this,arguments)}function i(){l||(s=w.onerror,w.onerror=o,l=!0)}function a(){l&&(w.onerror=s,l=!1,s=void 0)}function c(){var e=g,t=h;h=null,g=null,d=null,r.apply(null,[e,!1].concat(t))}function u(e,t){var n=x.call(arguments,1);if(g){if(d===e)return;c()}var r=b.computeStackTrace(e);if(g=r,d=e,h=n,setTimeout(function(){d===e&&c()},r.incomplete?2e3:0),!1!==t)throw e}var s,l,p=[],h=null,d=null,g=null;return u.subscribe=e,u.unsubscribe=t,u.uninstall=n,u}(),b.computeStackTrace=function(){function e(e){if(void 0!==e.stack&&e.stack){for(var t,n,r,o=/^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,i=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?)(?::(\d+))?(?::(\d+))?\s*$/i,a=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,c=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,u=/\((\S*)(?::(\d+))(?::(\d+))\)/,s=e.stack.split("\n"),l=[],p=(/^(.*) is undefined$/.exec(e.message),0),h=s.length;p<h;++p){if(n=o.exec(s[p])){var d=n[2]&&0===n[2].indexOf("native"),g=n[2]&&0===n[2].indexOf("eval");g&&(t=u.exec(n[2]))&&(n[2]=t[1],n[3]=t[2],n[4]=t[3]),r={url:d?null:n[2],func:n[1]||k,args:d?[n[2]]:[],line:n[3]?+n[3]:null,column:n[4]?+n[4]:null}}else if(n=a.exec(s[p]))r={url:n[2],func:n[1]||k,args:[],line:+n[3],column:n[4]?+n[4]:null};else{if(!(n=i.exec(s[p])))continue;var g=n[3]&&n[3].indexOf(" > eval")>-1;g&&(t=c.exec(n[3]))?(n[3]=t[1],n[4]=t[2],n[5]=null):0!==p||n[5]||void 0===e.columnNumber||(l[0].column=e.columnNumber+1),r={url:n[3],func:n[1]||k,args:n[2]?n[2].split(","):[],line:n[4]?+n[4]:null,column:n[5]?+n[5]:null}}!r.func&&r.line&&(r.func=k),l.push(r)}return l.length?{name:e.name,message:e.message,url:f(),stack:l}:null}}function t(e,t,n,r){var o={url:t,line:n};if(o.url&&o.line){if(e.incomplete=!1,o.func||(o.func=k),e.stack.length>0&&e.stack[0].url===o.url){if(e.stack[0].line===o.line)return!1;if(!e.stack[0].line&&e.stack[0].func===o.func)return e.stack[0].line=o.line,!1}return e.stack.unshift(o),e.partial=!0,!0}return e.incomplete=!0,!1}function n(e,o){for(var i,a,c=/function\s+([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)?\s*\(/i,u=[],s={},l=!1,p=n.caller;p&&!l;p=p.caller)if(p!==r&&p!==b.report){if(a={url:null,func:k,line:null,column:null},p.name?a.func=p.name:(i=c.exec(p.toString()))&&(a.func=i[1]),void 0===a.func)try{a.func=i.input.substring(0,i.input.indexOf("{"))}catch(e){}s[""+p]?l=!0:s[""+p]=!0,u.push(a)}o&&u.splice(0,o);var h={name:e.name,message:e.message,url:f(),stack:u};return t(h,e.sourceURL||e.fileName,e.line||e.lineNumber,e.message||e.description),h}function r(t,r){var o=null;r=null==r?0:+r;try{if(o=e(t))return o}catch(e){if(b.debug)throw e}try{if(o=n(t,r+1))return o}catch(e){if(b.debug)throw e}return{name:t.name,message:t.message,url:f()}}return r.augmentStackTraceWithInitialElement=t,r.computeStackTraceFromStackProp=e,r}();var S=(Object.assign||require("object-assign"),function(){function t(e){var n=this;d(this,t),this.Tracekit=b,this.lastGuid=null,this.lastReport=null,this._config=e,b.report.subscribe(function(e){n.handleStackInfo(e)}),this.breadcrumbs=new y(e)}return g(t,[{key:"handleStackInfo",value:function(e){var t=this.prepareFrames(e);r("handle",{stackInfo:e}),this.processException(e.name,e.message,e.url,t)}},{key:"prepareFrames",value:function(e){var t=this,n=[];return e.stack&&e.stack.length&&e.stack.forEach(function(e){var r=t.normalizeFrame(e);r&&n.push(r)}),n=n.slice(0,this._config.maxStackDepth)}},{key:"normalizeFrame",value:function(e){if(e.url){return{fileName:e.url,lineNumber:e.line,columnNumber:e.column,function:e.func||"?"}}}},{key:"processException",value:function(e,t,n,r){var o=this._config,i=[];if(!(o.ignoreErrors.test&&o.ignoreErrors.test(t)||(t+="",r&&r.length?(n=r[0].fileName||n,r.reverse(),i=r):n&&i.push({fileName:n}),o.ignoreUrls.test&&o.ignoreUrls.test(n)))){var a=[{type:e,message:t,stacktrace:i}];this.handlePayload(a)}}},{key:"handlePayload",value:function(e){var t={url:location.href,title:document.title,environment:h,exception:e,version:this._config.version,apiKey:this._config.apiKey,timestamp:(new Date).getTime(),guid:n(),breadcrumbs:this.breadcrumbs.crumbsData};this.sendPayload(t)}},{key:"sendPayload",value:function(t){var n=this;if(this.lastGuid=t.guid,this._config.repeatReport||!this.isRepeatReport(t)){this.lastReport=t;e({url:this._config.exceptionUrl,data:t,onSuccess:function(){return r("success",{data:t,src:n._config.exceptionUrl}),new Promise(function(){})},OnError:function(e){return r("failure",{data:t,src:n._config.exceptionUrl}),e=e||new Error("Trace: report sending failed!"),new Promise(function(t){return t(e)})}})}}},{key:"isRepeatReport",value:function(e){var t=this.lastReport;return!(!t||e.url!==t.url)&&(!e.exception&&!t.exception||this.isSameException(e.exception,t.exception))}},{key:"isSameException",value:function(e,t){if(!e.length||!t.length)return!1;var n=e[0],r=t[0];return n.type===r.type&&n.message===r.message&&this.isSameStacktrace(n.stacktrace,r.stacktrace)}},{key:"isSameStacktrace",value:function(e,t){return!(!e.length||!t.length)&&(e.forEach(function(e,n){if(e.fileName!==t[n].fileName||e.columnNumber!==t[n].columnNumber||e.lineNumber!==t[n].lineNumber||e.function!==t[n].function)return!1}),!0)}}]),t}()),C=Object.assign||require("object-assign");return function(){function e(){d(this,e),this.computeStackTrace=b.computeStackTrace,this.globalConfig=p}return g(e,[{key:"config",value:function(e){var t=this;this.globalConfig=C({},this.globalConfig,e),this.processConfig(),this.onError=new S(this.globalConfig),window.addEventListener("beforeunload",function(){new m(t.globalConfig).payloadSending()})}},{key:"captureException",value:function(e){if(!t(e))return this.captureMessage(e);try{var n=this.computeStackTrace(e);this.onError.handleStackInfo(n)}catch(t){if(e!==t)throw t}}},{key:"captureMessage",value:function(e){if(!this.globalConfig.ignoreErrors.test||!this.globalConfig.ignoreErrors.test(e)){var t=void 0;try{throw new Error(e)}catch(e){t=e}var n=this.computeStackTrace(t),r=this.onError.prepareFrames(n),o={stacktrace:r,message:e};this.onError.handlePayload([o])}}},{key:"processConfig",value:function(){var e=this.globalConfig.ignoreErrors,t=this.globalConfig.ignoreErrors;e.push(/^Script error\.?$/),e.push(/^Javascript error: Script error\.? on line 0$/),this.globalConfig.ignoreErrors=a(e),this.globalConfig.ignoreUrls=t.length&&a(t)}}]),e}()});
//# sourceMappingURL=trace.min.js.map
