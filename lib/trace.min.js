!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e._Trace=t()}(this,function(){"use strict";function e(e){switch(Object.prototype.toString.call(e)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return e instanceof Error}}function t(){var e=window.crypto||window.msCrypto;if(e&&e.getRandomValues){var t=new Uint16Array(8);e.getRandomValues(t),t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;var n=function(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t};return n(t[0])+n(t[1])+n(t[2])+n(t[3])+n(t[4])+n(t[5])+n(t[6])+n(t[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function n(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(document){var n=void 0,r=void 0;e=e.substr(0,1).toUpperCase+e.substr(1),document.createEvent?(n=document.createEvent("HTMLEvents")).initEvent(e,!0,!0):(n=document.createEventObject()).eventType=e;for(r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);document.createEvent?document.dispatchEvent(n):document.fireEvent("on"+n.eventType.toLowerCase(),n)}}function r(e,t,n,r){var o=e[t];e[t]=n(o),r&&r.push([e,t,o])}function o(e,t,n){function r(){var r=[],a=arguments.length,i=!e||e&&!1!==e.deep;for(n&&"function"==typeof n&&n.apply(this,arguments);a--;)r[a]=i?o(e,arguments[a]):arguments[a];try{return t.apply(this,r)}catch(e){throw e}}if(!t&&"function"!=typeof e)return e;if("function"==typeof e&&(t=e,e=void 0),"function"!=typeof t)return t;try{if(t.trace)return t;if(t.track_wrapper)return t.track_wrapper}catch(e){return t}for(var a in t)t.hasOwnProperty(process)&&(r[a]=t[a]);return r.prototype=t.prototype,t.track_wrapper=r,r}function a(e){for(var t=[],n=void 0,r=0;r<e.length;r++)"string"==typeof(n=e[r])?t.push(n.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")):n&&n.source&&t.push(n.source);return new RegExp(t.join("|"),"i")}function i(e){for(var t,n=[],r=0,o=0,a=" > ".length;e&&r++<5&&!("html"===(t=c(e))||r>1&&o+n.length*a+t.length>=80);)n.push(t),o+=t.length,e=e.parentElement;return n.reverse().join(" > ")}function c(e){var t,n,r,o,a,i=[];if(!e||!e.tagName)return"";if(i.push(e.tagName.toLowerCase()),e.id&&i.push("#"+e.id),(t=e.className)&&"string"==typeof t)for(n=t.split(/\s+/),a=0;a<n.length;a++)i.push("."+n[a]);var c=["type","name","title","alt"];for(a=0;a<c.length;a++)r=c[a],(o=e.getAttribute(r))&&i.push("["+r+'="'+o+'"]');return i.join("")}function s(e){var t=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(t){var n=t[6]||"",r=t[8]||"";return{protocol:t[2],host:t[4],path:t[5],relative:t[5]+n+r}}}function u(e){for(var t={},n=e.attributes,r=0;r<n.length;r++){var o=n[r];t[o.name]=o.value}return t}function l(e){var t=new XMLHttpRequest;if("withCredentials"in t||void 0!==window.XDomainRequest){var n=e.url;"withCredentials"in t?t.onreadystatechange=function(){if(4===t.readyState)if(200===t.status)e.onSuccess=e.onSuccess();else if(e.onError){var n=new Error("Error: "+t.status);n.request=t,e.onError(n)}}:(t=new window.XDomainRequest,n=n.replace(/^https?:/,""),e.onSuccess&&(t.onload=e.onSuccess),e.onError&&(t.onerror=function(){var n=new Error("Error: XDomainRequest");n.request=t,e.onError(n)})),t.open("POST",n,!0),t.send(JSON.stringify(e.data))}}var f={apiKey:"",exceptionUrl:"http://localhost:3001/tracer/error",performanceUrl:"http://localhost:3001/api/perf/create",ignoreErrors:[],ignoreUrls:[],autoBreadcrumbs:{dom:!0,xhr:!0,location:!0,console:!1},releaseStage:"production",catchAjax:!0,catchConsole:!0,maxStackDepth:10,repeatReport:!1,maxBreadcrumbs:100},p=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},h=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),d=function(){function e(t){p(this,e),this.config=t,this.getCollection()}return h(e,[{key:"payloadSending",value:function(){var e=this;if(this.collection&&!(this.collection.dom<0)){var t=JSON.stringify(this.collection);window.navigator&&window.navigator.sendBeacon?(console.log("url change"),window.navigator.sendBeacon(this.config.performanceUrl,t)):l({url:this.config.performanceUrl,data:t,onSuccess:function(){return n("success",{data:t,src:e.config.performanceUrl}),new Promise(function(){})},OnError:function(r){return n("failure",{data:t,src:e.config.performanceUrl}),r=r||new Error("发送上报请求失败"),new Promise(function(e){return e(r)})}})}}},{key:"getCollection",value:function(){if(window.performance){var e=window.performance.timing,t=window.performance.navigation,n=window.performance.getEntriesByType("resource"),r=e.redirectEnd-e.redirectStart,o=e.domainLookupEnd-e.domainLookupStart,a=e.connectEnd-e.connectStart,i=0===e.secureConnectionStart?0:e.secureConnectionStart-e.connectStart,c=e.responseStart-e.navigationStart,s=e.responseEnd-e.navigationStart,u=e.domComplete-e.responseEnd,l=e.domContentLoadedEventEnd-e.navigationStart,f=e.domInteractive-e.navigationStart,p=e.loadEventStart-e.navigationStart,h=t.redirectCount,d=t.type,m=[];n.forEach(function(e){var t=e.initiatorType,n=e.name,r=e.duration,o=e.transferSize;m.push({url:n,tag:t,duration:r.toFixed(2),size:o})}),this.collection={redirect:r,dns:o,tcp:a,tls:i,firstPaint:c,network:s,dom:u,firstScreen:l,interactive:f,pageLoad:p,redirectCount:h,navigationType:d,resources:m,userAgent:window.navigator.userAgent,url:window.location.href,protocol:window.location.protocol,apiKey:this.config.apiKey,domain:window.location.protocol+"//"+window.location.host,timing:JSON.stringify(e)}}}}]),e}(),m=function(){function e(t){p(this,e),this.crumbsData=[],this.wrappedBuiltIns=[],this.lastEvent=null,this.lastHref="",this._config=t,this.getDomBreadcrumbs(),this.getXhrBreadcrumbs(),this.getLocationBreadcurmbs(),this.getConsoleBreadcrumbs()}return h(e,[{key:"getDomBreadcrumbs",value:function(){var e=this;this._config.autoBreadcrumbs.dom&&(this.clickEventSelectors=["a","button","input[button]","input[submit]","input[radio]","input[checkbox]"],this.changeEventSelectors=["input[text]","input[password]","textarea","select"],document.addEventListener?(document.addEventListener("click",function(t){e.eventHandler("click",e.clickEventSelectors,t)},!0),document.addEventListener("blur",function(t){e.eventHandler("input",e.changeEventSelectors,t)},!0)):(document.attachEvent("onclick",function(t){e.eventHandler("click",e.clickEventSelectors,t)}),document.attachEvent("onblur",function(t){e.eventHandler("click",e.clickEventSelectors,t)})))}},{key:"eventHandler",value:function(e,t,n){var r=n.target||n.srcElement;r.tagName.toLowerCase();if(this.acceptTag(r,t)){u(r);var o={category:"ui."+e,htmlTree:i(r)};this.captureBreadcrumb(o)}}},{key:"acceptTag",value:function(e,t){var n=e.tagName.toLowerCase();return"input"===n&&e.getAttribute("type")&&(n+="["+e.getAttribute("type")+"]"),t.indexOf(n)>-1}},{key:"getXhrBreadcrumbs",value:function(){function e(e,t){e in t&&"function"==typeof t[e]&&r(t,e,function(e){return o(e)})}if(this._config.autoBreadcrumbs.xhr){var t=this,n=(this._config.autoBreadcrumbs,this.wrappedBuiltIns),a=XMLHttpRequest.prototype;r(a,"open",function(e){return function(t,n){return this._trace_xhr={method:t,url:n,statusCode:null},e.apply(this,arguments)}},n),r(a,"send",function(n){return function(a){function i(){!c._trace_xhr||1!==c.readyState&&4!==c.readyState||(c._trace_xhr.statusCode=c.status,t.captureBreadcrumb({type:"http",category:"xhr",data:c._trace_xhr}))}for(var c=this,s=["onload","onerror","onprogress"],u=0;u<s.length;u++)e(s[u],c);return"onreadystatechange"in c&&"function"==typeof c.onreadystatechange?r(c,"onreadystatechange",function(e){return o(e,void 0,i)}):c.onreadystatechange=i,n.apply(this,arguments)}},n)}}},{key:"getLocationBreadcurmbs",value:function(){if(this._config.autoBreadcrumbs.location){var e=this.wrappedBuiltIns,t=this,n=window.chrome;if(!(n&&n.app&&n.app.runtime)&&window.history&&history.pushState){var o=window.onpopstate;window.onpopstate=function(){var e=location.href;if(t.captureUrlChange(t.lastHref,e),o)return o.apply(this,arguments)},r(history,"pushState",function(e){return function(){var n=arguments.length>2?arguments[2]:void 0;return n&&t.captureUrlChange(t.lastHref,n+""),e.apply(this,arguments)}},e)}}}},{key:"captureUrlChange",value:function(e,t){var n=s(location.href),r=s(t),o=s(e);this.lastHref=t,n.protocol===r.protocol&&n.host===r.host&&(t=r.relative),n.protocol===o.protocol&&n.host===o.host&&(e=o.relative),new d(this._config).payloadSending(),this.captureBreadcrumb({category:"navigation",data:{to:t,from:e}})}},{key:"getConsoleBreadcrumbs",value:function(){var e=this;if(this._config.autoBreadcrumbs.console&&"console"in window&&console.log){var t=function(t,n){e.captureBreadcrumb({message:t,level:n.level,category:"console"})};["debug","info","warn","error","log"].forEach(function(n){e.wrapConsole(console,n,t)})}}},{key:"wrapConsole",value:function(e,t,n){var r=e[t],o=e;if(t in e){var a="warn"===t?"warning":t;e[t]=function(){var e=[].slice.call(arguments),t=""+e.join(" "),i={level:a,logger:"console",extra:{arguments:e}};n&&n(t,i),r&&Function.prototype.apply.call(r,o,e)}}}},{key:"captureBreadcrumb",value:function(e){var t=Object.assign({},e,{timestamp:(new Date).getTime()});this.crumbsData.push(t),this.crumbsData.length>this._config.maxBreadcrumbs&&this.crumbsData.shift()}}]),e}(),g={screenWidth:document.documentElement?document.documentElement.clientWidth:document.body.clientWidth,screenHeigth:document.documentElement?document.documentElement.clientHeight:document.body.clientHeight,userAgent:navigator.userAgent,language:navigator.language},v=function(){function e(t){p(this,e),this.lastGuid=null,this.lastReport=null,this.config=t,this.breadcrumbs=new m(t)}return h(e,[{key:"handleStackInfo",value:function(e){var t=this.prepareFrames(e);n("handle",{stackInfo:e});var r=e.type,o=e.message,a=e.url,i=e.lineNumber,c=e.columnNumber;this.handleException(r,o,a,i,c,t)}},{key:"handlePayload",value:function(e){var n={url:location.href,title:document.title,environment:g,exception:e,version:this.config.version,apiKey:this.config.apiKey,timestamp:(new Date).getTime(),guid:t(),breadcrumbs:this.breadcrumbs.crumbsData};this.sendPayload(n)}},{key:"prepareFrames",value:function(e){var t=e.stacktrace,n=[];return t.frames&&t.frames.length&&t.frames.forEach(function(e){n.push(e)}),n=n.slice(0,this.config.maxStackDepth)}},{key:"handleException",value:function(e,t,n,r,o,a){var i=this.config,c=void 0;if(!(i.ignoreErrors.test&&i.ignoreErrors.test(t)||(t+="",a&&a.length?(n=a[0].fileName||n,a.reverse(),c={frames:a}):n&&(c={frames:[{fileName:n,lineNumber:r,columnNumber:o}]}),i.ignoreUrls.test&&i.ignoreUrls.test(n)))){var s={type:e,message:t,stacktrace:c};this.handlePayload(s)}}},{key:"sendPayload",value:function(e){var t=this;this.lastGuid=e.guid,!this.config.repeatReport&&this.isRepeatReport(e)||(this.lastReport=e,l({url:this.config.exceptionUrl,data:e,onSuccess:function(){return n("success",{data:e,src:t.config.exceptionUrl}),new Promise(function(){})},OnError:function(r){return n("failure",{data:e,src:t.config.exceptionUrl}),r=r||new Error("Trace: report sending failed!"),new Promise(function(e){return e(r)})}}))}},{key:"isRepeatReport",value:function(e){var t=this.lastReport;return!(!t||e.url!==t.url)&&(!e.exception&&!t.exception||this.isSameException(e.exception,t.exception))}},{key:"isSameException",value:function(e,t){if(!e||!t)return!1;var n=e,r=t;return n.type===r.type&&n.message===r.message&&this.isSameStacktrace(n.stacktrace.frames,r.stacktrace.frames)}},{key:"isSameStacktrace",value:function(e,t){return!(!e.length||!t.length)&&(e.forEach(function(e,n){if(e.fileName!==t[n].fileName||e.columnNumber!==t[n].columnNumber||e.lineNumber!==t[n].lineNumber||e.func!==t[n].func)return!1}),!0)}}]),e}(),y=function(){function e(t){p(this,e),this.originOnError=window.onerror,this.ERROR_TYPES=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/,this.handleWindowOnError(),this.report=new v(t)}return h(e,[{key:"handleWindowOnError",value:function(){var e=this,t=null;window.onerror=function(n,r,o,a,i){if(i)t=e.analyzeErrorStack(i);else{var c={fileName:r,lineNumber:o,columnNumber:a,func:"?"},s=void 0,u=n;if("[object String]"===Object.prototype.toString.call(n)){var l=n.match(e.ERROR_TYPES);l&&(s=l[1],u=l[2])}t={type:s,message:u,lineNumber:o,columnNumber:a,stacktrace:{frames:[c]}}}return e.originOnError&&e.originOnError.apply(window,arguments),e.report.handleStackInfo(t),!1}}},{key:"analyzeErrorStack",value:function(e,t){var n=e.name,r=e.message;t=null==t?0:+t;var o=void 0;try{if(o=this.analyzeStackFromProp(e))return o}catch(e){}try{if(o=this.analyzeStackFromCaller(e,t+1))return o}catch(e){}return{type:n,message:r,url:window.location.href}}},{key:"analyzeStackFromProp",value:function(e){var t=e.name,n=e.stack,r=e.message;if(void 0!==n&&n){for(var o=/^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,a=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?)(?::(\d+))?(?::(\d+))?\s*$/i,i=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,c=/\((\S*)(?::(\d+))(?::(\d+))\)/,s=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,u=n.split("\n"),l=(/^(.*) is undefined$/.exec(r),[]),f=void 0,p=void 0,h=void 0,d=0,m=u.length;d<m;++d){if(p=o.exec(u[d])){var g=p[2]&&0===p[2].indexOf("native");p[2]&&0===p[2].indexOf("eval")&&(f=c.exec(p[2]))&&(p[2]=f[1],p[3]=f[2],p[4]=f[3]),h={fileName:g?null:p[2],func:p[1]||"?",args:g?[p[2]]:[],lineNumber:p[3]?+p[3]:null,columnNumber:p[4]?+p[4]:null}}else if(p=i.exec(u[d]))h={fileName:p[2],func:p[1]||"?",args:[],lineNumber:+p[3],columnNumber:p[4]?+p[4]:null};else{if(!(p=a.exec(u[d])))continue;p[3]&&p[3].indexOf(" > eval")>-1&&(f=s.exec(p[3]))?(p[3]=f[1],p[4]=f[2],p[5]=null):0!==d||p[5]||void 0===e.columnNumber||(l[0].columnNumber=e.columnNumber+1),h={fileName:p[3],func:p[1]||"?",args:p[2]?p[2].split(","):[],lineNumber:p[4]?+p[4]:null,columnNumber:p[5]?+p[5]:null}}!h.func&&h.lineNumber&&(h.func="?"),0===h.args.length&&delete h.args,l.push(h)}return l.length?{type:t,message:r,stacktrace:{frames:l}}:null}}},{key:"analyzeStackFromCaller",value:function(e,t){for(var n=e.name,r=e.message,o=/function\s+([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)?\s*\(/i,a=[],i={},c=!1,s=void 0,u=void 0,l=this.analyzeStackFromCaller.caller;l&&!c;l=l.caller)l!==this.analyzeStackFromProp&&(u={fileName:null,func:"?",lineNumber:null,columnNumber:null},l.name?u.func=l.name:(s=o.exec(l.toString()))&&(u.func=s[1]),void 0===u.func&&(u.func=s.input.substring(0,s.indexOf("{"))),i[""+l]?c=!0:i[""+l]=!0,a.push(u));t&&a.splice(0,t);var f={type:n,message:r,stacktrace:{frames:a}},p=e;return this.analyzeFirstFrame(f,p.sourceURL||p.fileName,p.line||p.lineNumber,p.message||p.description),f}},{key:"analyzeFirstFrame",value:function(e,t,n,r){var o={url:t,line:n,func:"?"};if(o.url&&o.line){if(e.incomplete=!1,e.stack.length>0&&e.stack[0].url===o.url){if(e.stack[0].line===o.line)return!1;if(!e.stack[0].line&&e.stack[0].func===o.func)return e.stack[0].line=o.line,!1}return e.stack.unshift(o),e.partial=!0,!0}return e.incomplete=!0,!1}}]),e}();return function(){function t(){p(this,t),this.globalConfig=f}return h(t,[{key:"config",value:function(e){var t=this;this.globalConfig=Object.assign({},this.globalConfig,e),this.processConfig(),this.report=new v(this.globalConfig),this.analyzeErrorStack=new y(this.globalConfig).analyzeErrorStack,window.addEventListener("beforeunload",function(){new d(t.globalConfig).payloadSending()})}},{key:"captureException",value:function(t){if(!e(t))return this.captureMessage(t);try{var n=this.analyzeErrorStack(t);this.report.handleStackInfo(n)}catch(e){if(t!==e)throw e}}},{key:"captureMessage",value:function(e){if(!this.globalConfig.ignoreErrors.test||!this.globalConfig.ignoreErrors.test(e)){var t=void 0;try{throw new Error(e)}catch(e){t=e}var n=this.analyzeErrorStack(t),r={stacktrace:{frames:this.report.prepareFrames(n)},message:e};this.report.handlePayload(r)}}},{key:"processConfig",value:function(){var e=this.globalConfig.ignoreErrors,t=this.globalConfig.ignoreErrors;e.push(/^Script error\.?$/),e.push(/^Javascript error: Script error\.? on line 0$/),this.globalConfig.ignoreErrors=a(e),this.globalConfig.ignoreUrls=t.length&&a(t)}}]),t}()}),window.Trace=new _Trace;
//# sourceMappingURL=trace.min.js.map
