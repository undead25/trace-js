!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.trace=t()}(this,function(){"use strict";function e(){return"undefined"==typeof document||void 0===document.location?"":document.location.href}function t(e){var t=new XMLHttpRequest;if("withCredentials"in t||"undefined"!=typeof XDomainRequest){var n=e.url;"withCredentials"in t?t.onreadystatechange=function(){if(4===t.readyState)if(200===t.status)e.onSuccess=e.onSuccess();else if(e.onError){var n=new Error("Error: "+t.status);n.request=t,e.onError(n)}}:(t=new XDomainRequest,n=n.replace(/^https?:/,""),e.onSuccess&&(t.onload=e.onSuccess),e.onError&&(t.onerror=function(){var n=new Error("Error: XDomainRequest");n.request=t,e.onError(n)})),t.open("POST",n,!0),t.send(JSON.stringify(e.data))}}function n(){var e=window.crypto||window.msCrypto;if(e&&e.getRandomValues){var t=new Uint16Array(8);e.getRandomValues(t),t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;var n=function(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t};return n(t[0])+n(t[1])+n(t[2])+n(t[3])+n(t[4])+n(t[5])+n(t[6])+n(t[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(document){var n=void 0,r=void 0;e=e.substr(0,1).toUpperCase+e.substr(1),document.createEvent?(n=document.createEvent("HTMLEvents"),n.initEvent(e,!0,!0)):(n=document.createEventObject(),n.eventType=e);for(r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);document.createEvent?document.dispatchEvent(n):document.fireEvent("on"+n.eventType.toLowerCase(),n)}}function o(e,t,n,r){var o=e[t];e[t]=n(o),r&&r.push([e,t,o])}function a(e,t,n){function r(){var r=[],o=arguments.length,i=!e||e&&!1!==e.deep;for(n&&"function"==typeof n&&n.apply(this,arguments);o--;)r[o]=i?a(e,arguments[o]):arguments[o];try{return t.apply(this,r)}catch(e){throw e}}if(!t&&"function"!=typeof e)return e;if("function"==typeof e&&(t=e,e=void 0),"function"!=typeof t)return t;try{if(t.trace)return t;if(t.track_wrapper)return t.track_wrapper}catch(e){return t}for(var o in t)t.hasOwnProperty(process)&&(r[o]=t[o]);return r.prototype=t.prototype,t.track_wrapper=r,r}function i(e){for(var t=[],n=void 0,r=0;r<e.length;r++)n=e[r],"string"==typeof n?t.push(n.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")):n&&n.source&&t.push(n.source);return new RegExp(t.join("|"),"i")}function c(e){for(var t,n=[],r=0,o=0,a=" > ".length;e&&r++<5&&!("html"===(t=u(e))||r>1&&o+n.length*a+t.length>=80);)n.push(t),o+=t.length,e=e.parentElement;return n.reverse().join(" > ")}function u(e){var t,n,r,o,a,i=[];if(!e||!e.tagName)return"";if(i.push(e.tagName.toLowerCase()),e.id&&i.push("#"+e.id),(t=e.className)&&"string"==typeof t)for(n=t.split(/\s+/),a=0;a<n.length;a++)i.push("."+n[a]);var c=["type","name","title","alt"];for(a=0;a<c.length;a++)r=c[a],(o=e.getAttribute(r))&&i.push("["+r+'="'+o+'"]');return i.join("")}function s(e){var t=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(t){var n=t[6]||"",r=t[8]||"";return{protocol:t[2],host:t[4],path:t[5],relative:t[5]+n+r}}}function l(e){for(var t={},n=e.attributes,r=0;r<n.length;r++){var o=n[r];t[o.name]=o.value}return t}var f={apiKey:"",enabled:!0,reportUrl:"http://localhost:3001/tracer/error",ignoreErrors:[],ignoreUrls:[],autoBreadcrumbs:{dom:!0,xhr:!0,location:!0,console:!1},releaseStage:"production",catchAjax:!0,catchConsole:!0,disableLog:!1,maxStackDepth:10,repeatReport:!1,maxBreadcrumbs:100},p={collectWindowErrors:!0,debug:!1},h="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},d=[].slice,m="?",g=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/;p.report=function(){function t(e){i(),v.push(e)}function n(e){for(var t=v.length-1;t>=0;--t)v[t]===e&&v.splice(t,1)}function r(){c(),v=[]}function o(e,t){var n=null;if(!t||p.collectWindowErrors){for(var r in v)if(v.hasOwnProperty(r))try{v[r].apply(null,[e].concat(d.call(arguments,2)))}catch(e){n=e}if(n)throw n}}function a(t,n,r,a,i){var c=null;if(x)p.computeStackTrace.augmentStackTraceWithInitialElement(x,n,r,t),u();else if(i)c=p.computeStackTrace(i),o(c,!0);else{var s,f={url:n,line:r,column:a},h=void 0,d=t;if("[object String]"==={}.toString.call(t)){var s=t.match(g);s&&(h=s[1],d=s[2])}f.func=m,c={name:h,message:d,url:e(),stack:[f]},o(c,!0)}return!!l&&l.apply(this,arguments)}function i(){f||(l=h.onerror,h.onerror=a,f=!0)}function c(){f&&(h.onerror=l,f=!1,l=void 0)}function u(){var e=x,t=b;b=null,x=null,y=null,o.apply(null,[e,!1].concat(t))}function s(e,t){var n=d.call(arguments,1);if(x){if(y===e)return;u()}var r=p.computeStackTrace(e);if(x=r,y=e,b=n,setTimeout(function(){y===e&&u()},r.incomplete?2e3:0),!1!==t)throw e}var l,f,v=[],b=null,y=null,x=null;return s.subscribe=t,s.unsubscribe=n,s.uninstall=r,s}(),p.computeStackTrace=function(){function t(t){if(void 0!==t.stack&&t.stack){for(var n,r,o,a=/^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,i=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?)(?::(\d+))?(?::(\d+))?\s*$/i,c=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,u=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,s=/\((\S*)(?::(\d+))(?::(\d+))\)/,l=t.stack.split("\n"),f=[],p=(/^(.*) is undefined$/.exec(t.message),0),h=l.length;p<h;++p){if(r=a.exec(l[p])){var d=r[2]&&0===r[2].indexOf("native"),g=r[2]&&0===r[2].indexOf("eval");g&&(n=s.exec(r[2]))&&(r[2]=n[1],r[3]=n[2],r[4]=n[3]),o={url:d?null:r[2],func:r[1]||m,args:d?[r[2]]:[],line:r[3]?+r[3]:null,column:r[4]?+r[4]:null}}else if(r=c.exec(l[p]))o={url:r[2],func:r[1]||m,args:[],line:+r[3],column:r[4]?+r[4]:null};else{if(!(r=i.exec(l[p])))continue;var g=r[3]&&r[3].indexOf(" > eval")>-1;g&&(n=u.exec(r[3]))?(r[3]=n[1],r[4]=n[2],r[5]=null):0!==p||r[5]||void 0===t.columnNumber||(f[0].column=t.columnNumber+1),o={url:r[3],func:r[1]||m,args:r[2]?r[2].split(","):[],line:r[4]?+r[4]:null,column:r[5]?+r[5]:null}}!o.func&&o.line&&(o.func=m),f.push(o)}return f.length?{name:t.name,message:t.message,url:e(),stack:f}:null}}function n(e,t,n,r){var o={url:t,line:n};if(o.url&&o.line){if(e.incomplete=!1,o.func||(o.func=m),e.stack.length>0&&e.stack[0].url===o.url){if(e.stack[0].line===o.line)return!1;if(!e.stack[0].line&&e.stack[0].func===o.func)return e.stack[0].line=o.line,!1}return e.stack.unshift(o),e.partial=!0,!0}return e.incomplete=!0,!1}function r(t,a){for(var i,c,u=/function\s+([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)?\s*\(/i,s=[],l={},f=!1,h=r.caller;h&&!f;h=h.caller)if(h!==o&&h!==p.report){if(c={url:null,func:m,line:null,column:null},h.name?c.func=h.name:(i=u.exec(h.toString()))&&(c.func=i[1]),void 0===c.func)try{c.func=i.input.substring(0,i.input.indexOf("{"))}catch(e){}l[""+h]?f=!0:l[""+h]=!0,s.push(c)}a&&s.splice(0,a);var d={name:t.name,message:t.message,url:e(),stack:s};return n(d,t.sourceURL||t.fileName,t.line||t.lineNumber,t.message||t.description),d}function o(n,o){var a=null;o=null==o?0:+o;try{if(a=t(n))return a}catch(e){if(p.debug)throw e}try{if(a=r(n,o+1))return a}catch(e){if(p.debug)throw e}return{name:n.name,message:n.message,url:e()}}return o.augmentStackTraceWithInitialElement=n,o.computeStackTraceFromStackProp=t,o}();var v={screenWidth:document.documentElement?document.documentElement.clientWidth:document.body.clientWidth,screenHeigth:document.documentElement?document.documentElement.clientHeight:document.body.clientHeight,userAgent:navigator.userAgent,language:navigator.language},b=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},y=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),x=Object.assign||require("object-assign"),k=function(){function e(t){b(this,e),this.crumbsData=[],this.wrappedBuiltIns=[],this.lastEvent=null,this.lastHref="",this._config=t,this.getDomBreadcrumbs(),this.getXhrBreadcrumbs(),this.getLocationBreadcurmbs(),this.getConsoleBreadcrumbs()}return y(e,[{key:"getDomBreadcrumbs",value:function(){var e=this;this._config.autoBreadcrumbs.dom&&(this.clickEventSelectors=["a","button","input[button]","input[submit]","input[radio]","input[checkbox]"],this.changeEventSelectors=["input[text]","input[password]","textarea","select"],document.addEventListener?(document.addEventListener("click",function(t){e.eventHandler("click",e.clickEventSelectors,t)},!0),document.addEventListener("blur",function(t){e.eventHandler("input",e.changeEventSelectors,t)},!0)):(document.attachEvent("onclick",function(t){e.eventHandler("click",e.clickEventSelectors,t)}),document.attachEvent("onblur",function(t){e.eventHandler("click",e.clickEventSelectors,t)})))}},{key:"eventHandler",value:function(e,t,n){var r=n.target||n.srcElement;r.tagName.toLowerCase();if(this.acceptTag(r,t)){var o=(l(r),{category:"ui."+e,htmlTree:c(r)});this.captureBreadcrumb(o)}}},{key:"acceptTag",value:function(e,t){var n=e.tagName.toLowerCase();return"input"===n&&e.getAttribute("type")&&(n+="["+e.getAttribute("type")+"]"),t.indexOf(n)>-1}},{key:"getXhrBreadcrumbs",value:function(){function e(e,t){e in t&&"function"==typeof t[e]&&o(t,e,function(e){return a(e)})}if(this._config.autoBreadcrumbs.xhr){var t=this,n=(this._config.autoBreadcrumbs,this.wrappedBuiltIns),r=XMLHttpRequest.prototype;o(r,"open",function(e){return function(t,n){return this._trace_xhr={method:t,url:n,statusCode:null},e.apply(this,arguments)}},n),o(r,"send",function(n){return function(r){function i(){!c._trace_xhr||1!==c.readyState&&4!==c.readyState||(c._trace_xhr.statusCode=c.status,t.captureBreadcrumb({type:"http",category:"xhr",data:c._trace_xhr}))}for(var c=this,u=["onload","onerror","onprogress"],s=0;s<u.length;s++)e(u[s],c);return"onreadystatechange"in c&&"function"==typeof c.onreadystatechange?o(c,"onreadystatechange",function(e){return a(e,void 0,i)}):c.onreadystatechange=i,n.apply(this,arguments)}},n)}}},{key:"getLocationBreadcurmbs",value:function(){if(this._config.autoBreadcrumbs.location){var e=this.wrappedBuiltIns,t=this,n=window.chrome;if(!(n&&n.app&&n.app.runtime)&&window.history&&history.pushState){var r=window.onpopstate;window.onpopstate=function(){var e=location.href;if(t.captureUrlChange(t.lastHref,e),r)return r.apply(this,arguments)},o(history,"pushState",function(e){return function(){var n=arguments.length>2?arguments[2]:void 0;return n&&t.captureUrlChange(t.lastHref,n+""),e.apply(this,arguments)}},e)}}}},{key:"captureUrlChange",value:function(e,t){var n=s(location.href),r=s(t),o=s(e);this.lastHref=t,n.protocol===r.protocol&&n.host===r.host&&(t=r.relative),n.protocol===o.protocol&&n.host===o.host&&(e=o.relative),this.captureBreadcrumb({category:"navigation",data:{to:t,from:e}})}},{key:"getConsoleBreadcrumbs",value:function(){var e=this;if(this._config.autoBreadcrumbs.console&&"console"in window&&console.log){var t=function(t,n){e.captureBreadcrumb({message:t,level:n.level,category:"console"})};["debug","info","warn","error","log"].forEach(function(n){e.wrapConsole(console,n,t)})}}},{key:"wrapConsole",value:function(e,t,n){var r=e[t],o=e;if(t in e){var a="warn"===t?"warning":t;e[t]=function(){var e=[].slice.call(arguments),t=""+e.join(" "),i={level:a,logger:"console",extra:{arguments:e}};n&&n(t,i),r&&Function.prototype.apply.call(r,o,e)}}}},{key:"captureBreadcrumb",value:function(e){var t=x({},e,{timestamp:(new Date).getTime()});this.crumbsData.push(t),this.crumbsData.length>this._config.maxBreadcrumbs&&this.crumbsData.shift()}}]),e}(),w=(Object.assign||require("object-assign"),function(){function e(t){var n=this;b(this,e),this.TraceKit=p,this.lastGuid=null,this.lastReport=null,this._config=t,p.report.subscribe(function(e){n.handleStackInfo(e)}),this.breadcrumbs=new k(t)}return y(e,[{key:"handleStackInfo",value:function(e){var t=this.prepareFrames(e);r("handle",{stackInfo:e}),this.processException(e.name,e.message,e.url,t)}},{key:"prepareFrames",value:function(e){var t=this,n=[];return e.stack&&e.stack.length&&e.stack.forEach(function(e){var r=t.normalizeFrame(e);r&&n.push(r)}),n=n.slice(0,this._config.maxStackDepth)}},{key:"normalizeFrame",value:function(e){if(e.url){return{fileName:e.url,lineNumber:e.line,columnNumber:e.column,function:e.func||"?"}}}},{key:"processException",value:function(e,t,n,r){var o=this._config,a=[];if(!(o.ignoreErrors.test&&o.ignoreErrors.test(t)||(t+="",r&&r.length?(n=r[0].fileName||n,r.reverse(),a=r):n&&a.push({fileName:n}),o.ignoreUrls.test&&o.ignoreUrls.test(n)))){var i=[{type:e,message:t,stacktrace:a}];this.handlePayload(i)}}},{key:"handlePayload",value:function(e){var t={url:location.href,title:document.title,environment:v,exception:e,version:this._config.version,apiKey:this._config.apiKey,timestamp:(new Date).getTime(),guid:n(),breadcrumbs:this.breadcrumbs.crumbsData};this.sendPayload(t)}},{key:"sendPayload",value:function(e){var n=this;if(this._config.enabled&&(this.lastGuid=e.guid,this._config.repeatReport||!this.isRepeatReport(e))){this.lastReport=e;t({url:this._config.reportUrl,data:e,onSuccess:function(){return r("success",{data:e,src:n._config.reportUrl}),new Promise(function(){})},OnError:function(t){return r("failure",{data:e,src:n._config.reportUrl}),t=t||new Error("发送上报请求失败"),new Promise(function(e){return e(t)})}})}}},{key:"isRepeatReport",value:function(e){var t=this.lastReport;return!(!t||e.url!==t.url)&&(!e.exception&&!t.exception||this.isSameException(e.exception,t.exception))}},{key:"isSameException",value:function(e,t){if(!e.length||!t.length)return!1;var n=e[0],r=t[0];return n.type===r.type&&n.message===r.message&&this.isSameStacktrace(n.stacktrace,r.stacktrace)}},{key:"isSameStacktrace",value:function(e,t){return!(!e.length||!t.length)&&(e.forEach(function(e,n){if(e.fileName!==t[n].fileName||e.columnNumber!==t[n].columnNumber||e.lineNumber!==t[n].lineNumber||e.function!==t[n].function)return!1}),!0)}}]),e}()),E=Object.assign||require("object-assign"),S=function(){function e(t){b(this,e),this.globalConfig=f,this.globalConfig=E({},this.globalConfig,t),this.handleConfig(),new w(this.globalConfig)}return y(e,[{key:"handleConfig",value:function(){var e=this.globalConfig.ignoreErrors,t=this.globalConfig.ignoreErrors;e.push(/^Script error\.?$/),e.push(/^Javascript error: Script error\.? on line 0$/),this.globalConfig.ignoreErrors=i(e),this.globalConfig.ignoreUrls=t.length&&i(t)}}]),e}();return(window||void 0).Trace=S,S});
//# sourceMappingURL=trace.min.js.map
